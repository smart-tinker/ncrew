# –ê—É–¥–∏—Ç ACP-–∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–µ—Å—Å–∏—è–º–∏

**–î–∞—Ç–∞:** 2024  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–û–±–ª–∞—Å—Ç—å:** OpenCode ACP, Qwen ACP, Gemini ACP Connectors  

---

## –†–µ–∑—é–º–µ

–ü—Ä–æ–≤–µ–¥–µ–Ω –≥–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç —Ç—Ä–µ—Ö ACP-–∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –º—É–ª—å—Ç–∏—Ç—É—Ä–Ω–æ–≤–æ–π –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥–∞. –í—Å–µ —Ç—Ä–∏ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞ —Å–ª–µ–¥—É—é—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∞–ª–∏–∑—É—é—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª ACP 0.1.4, –ø–æ–ª–∞–≥–∞—è—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—É—é (CLI-–∞–≥–µ–Ω—Ç—Å–∫—É—é) —Å—Ç–æ—Ä–æ–Ω—É –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–µ—Å—Å–∏–∏.

**–ö–ª—é—á–µ–≤–æ–π –≤—ã–≤–æ–¥:** –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –¥–ª—è ACP-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –ú—É–ª—å—Ç–∏—Ç—É—Ä–Ω–æ–≤–∞—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å–µ—Å—Å–∏—é CLI-–∞–≥–µ–Ω—Ç–∞. –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –º–∏–Ω–æ—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã: –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –Ω–µ–ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏ –æ–¥–∏–Ω copy-paste –±–∞–≥.

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ACP-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞

### 1.1. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å–µ—Å—Å–∏–∏

ACP (Agent Communication Protocol) —Å–ª–µ–¥—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ JSON-RPC 2.0:

```
launch() ‚Üí initialize ‚Üí session/new ‚Üí session/prompt* ‚Üí session/cancel ‚Üí shutdown()
```

1. **`initialize`** ‚Äî Handshake –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –∞–≥–µ–Ω—Ç–æ–º, –æ–±–º–µ–Ω capabilities –∏ auth methods
2. **`session/new`** ‚Äî –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º `sessionId`
3. **`session/prompt`** ‚Äî –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ –∞–≥–µ–Ω—Ç—É (–ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è)
4. **`session/update`** ‚Äî –ü–æ—Ç–æ–∫–æ–≤–∞—è –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å —á–∞–Ω–∫–∞–º–∏ –æ—Ç–≤–µ—Ç–∞ –∞–≥–µ–Ω—Ç–∞
5. **`session/cancel`** ‚Äî –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
6. **–ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–µ—Ç—Å—è –∂–∏–≤—ã–º** –º–µ–∂–¥—É –ø—Ä–æ–º–ø—Ç–∞–º–∏, CLI-–∞–≥–µ–Ω—Ç —Ö—Ä–∞–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ

### 1.2. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      initialize        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Connector  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ  CLI Agent  ‚îÇ
‚îÇ  (NeuroCrew) ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  (ACP mode) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   capabilities+auth   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                                       ‚îÇ
       ‚îÇ          session/new                  ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
       ‚îÇ           sessionId                   ‚îÇ
       ‚îÇ                                       ‚îÇ
       ‚îÇ    session/prompt (user text)         ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ<‚îÄ‚îÄ session/update (chunks) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
       ‚îÇ<‚îÄ‚îÄ result (stopReason) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
       ‚îÇ                                       ‚îÇ
       ‚îÇ    session/prompt (next delta)        ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ<‚îÄ‚îÄ session/update (chunks) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
       ‚îÇ<‚îÄ‚îÄ result ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
       ‚îÇ                                       ‚îÇ
      ...                                     ...
       ‚îÇ                                       ‚îÇ
       ‚îÇ    session/cancel                     ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
       ‚îÇ    SIGTERM/SIGKILL                    ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤

| –ê—Å–ø–µ–∫—Ç | OpenCode ACP | Qwen ACP | Gemini ACP |
|--------|-------------|----------|------------|
| **–ü—Ä–æ—Ç–æ–∫–æ–ª –≤–µ—Ä—Å–∏—è** | ACP 1.0 | ACP 0.1.4 | ACP experimental |
| **CLI –∫–æ–º–∞–Ω–¥–∞** | `opencode acp` | `qwen --experimental-acp` | `gemini --experimental-acp` |
| **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** | –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ | –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ `qwen-oauth` | –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ `gemini-api-key` |
| **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** | ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | ‚ùå –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| **Session ID** | ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è CLI | ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è CLI | ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è CLI |
| **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞** | ‚úÖ Stateful | ‚úÖ Stateful | ‚úÖ Stateful |
| **–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞** | max(5s, AGENT_TIMEOUT) | max(5s, AGENT_TIMEOUT) | max(5s, AGENT_TIMEOUT) |
| **–¢–∞–π–º–∞—É—Ç —á—Ç–µ–Ω–∏—è** | 10s per readline | 10s per readline | 10s per readline |
| **–ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞** | –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–∞ | –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–∞ | –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–∞ |
| **–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** | –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π delta | –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π delta | –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π delta |
| **Reconnect –ª–æ–≥–∏–∫–∞** | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç |
| **Session persistence** | –î–æ —è–≤–Ω–æ–≥–æ shutdown | –î–æ —è–≤–Ω–æ–≥–æ shutdown | –î–æ —è–≤–Ω–æ–≥–æ shutdown |
| **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π** | ‚úÖ Auto-grant –ø–µ—Ä–≤–æ–π –æ–ø—Ü–∏–∏ | ‚úÖ Auto-grant –ø–µ—Ä–≤–æ–π –æ–ø—Ü–∏–∏ | ‚úÖ Auto-grant –ø–µ—Ä–≤–æ–π –æ–ø—Ü–∏–∏ |
| **Streaming chunks** | ‚úÖ agent_message_chunk | ‚úÖ agent_message_chunk | ‚úÖ agent_message_chunk |
| **Agent thoughts** | ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è | ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è | ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è |
| **–û—à–∏–±–∫–∏ –≤ stderr** | –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫—É –æ—à–∏–±–∫–∏ | –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫—É –æ—à–∏–±–∫–∏ | ‚úÖ –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (data.details) |

---

## 3. –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—É

### 3.1. OpenCode ACP Connector

**–§–∞–π–ª:** `app/connectors/opencode_acp_connector.py`  
**–¢–µ—Å—Ç:** `tests/test_opencode_acp.py`

#### Handshake & Authentication

```python
# initialize ‚Üí –ø–æ–ª—É—á–µ–Ω–∏–µ capabilities –∏ auth methods
async def _initialize(self):
    response, _ = await self._send_request("initialize", {
        "protocolVersion": 1,
        "clientCapabilities": {"fs": {"readTextFile": False, "writeTextFile": False}}
    })
    self.initialized = True
    self.agent_capabilities = response.get("agentCapabilities", {})
    self.available_auth_methods = [
        str(method.get("id"))
        for method in response.get("authMethods", [])
        if isinstance(method, dict) and method.get("id")
    ]
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω  
**–ü—Ä–æ–±–ª–µ–º–∞:** `available_auth_methods` –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è, –Ω–æ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è  
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** CLI OpenCode —É–∂–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ `opencode login`  
**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º (no-op auth)

#### Session Creation

```python
async def _create_session(self):
    result, _ = await self._send_request("session/new", {
        "cwd": str(Path.cwd()),
        "mcpServers": []
    })
    session_id = result.get("sessionId")
    if not session_id:
        raise RuntimeError("OpenCode ACP did not return a sessionId.")
    self.session_id = session_id
    if self.process:
        self.current_session = _SessionInfo(pid=self.process.pid, session_id=session_id)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω  
**Session ID:** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≥–µ–Ω—Ç–æ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `self.session_id`  
**Process persistence:** `self.current_session` —Å–≤—è–∑—ã–≤–∞–µ—Ç PID —Å session ID

#### System Prompt & Delta Transmission

```python
async def _send_prompt(self, prompt: str) -> str:
    result, aggregated_text = await self._send_request("session/prompt", {
        "sessionId": self.session_id,
        "prompt": [{"type": "text", "text": prompt}]
    }, collect_output=True)
    return aggregated_text
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è ACP-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞  
**–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:** –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞  
**–ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è:** –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤  
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** CLI-–∞–≥–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏ –Ω–∞ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ  
**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:** –¢–µ—Å—Ç `test_opencode_acp_connector_integration` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç multi-turn

#### Conversation History Storage

```python
async def execute(self, delta_prompt: str) -> str:
    if not self.is_alive() or not self.session_id:
        raise RuntimeError("OpenCode ACP session is not active.")
    
    response_text = await self._send_prompt(delta_prompt)
    if response_text:
        self._conversation_history.append(response_text)  # –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã!
    return response_text
```

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ–ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è  
**–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–∞  
**–ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è:** –ü—Ä–æ–º–ø—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
**–ü—Ä–æ–±–ª–µ–º–∞:** `get_session_history()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç incomplete view  
**–í–ª–∏—è–Ω–∏–µ:** –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ ‚Äî —ç—Ç–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–∞—Ä—ã (prompt, response) –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã

#### Timeout Handling

```python
self.request_timeout: float = max(5.0, float(getattr(Config, "AGENT_TIMEOUT", 120)))

# –í _send_request:
loop = asyncio.get_running_loop()
deadline = loop.time() + self.request_timeout

while True:
    remaining = deadline - loop.time()
    if remaining <= 0:
        raise RuntimeError(f"OpenCode ACP timeout while waiting for {method}")
    
    try:
        message = await asyncio.wait_for(
            self._read_message(), 
            timeout=remaining
        )
        deadline = loop.time() + self.request_timeout  # Reset –Ω–∞ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    except asyncio.TimeoutError:
        raise RuntimeError(f"OpenCode ACP timeout while waiting for {method}")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π —Ç–∞–π–º–∞—É—Ç  
**–£—Ä–æ–≤–µ–Ω—å 1:** –û–±—â–∏–π request timeout (min 5s, default 120s) ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏  
**–£—Ä–æ–≤–µ–Ω—å 2:** Read timeout 10s per `readline()` ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è  
**–û—à–∏–±–∫–∏:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (method, request_id, elapsed time)

#### Reconnect/Shutdown

```python
async def shutdown(self):
    if self.is_alive() and self.session_id:
        try:
            await self._send_notification("session/cancel", {"sessionId": self.session_id})
        except Exception:
            pass  # Best-effort
    await super().shutdown()  # Graceful SIGTERM ‚Üí SIGKILL
    self.session_id = None
    self.initialized = False
    self.authenticated = False
    self.current_session = None
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Graceful shutdown  
**Reconnect:** –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ reconnect. –ü—Ä–∏ –≤—ã–∑–æ–≤–µ `launch()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `is_alive()` –∏ –¥–µ–ª–∞–µ—Ç—Å—è `shutdown()` –µ—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –º–µ—Ä—Ç–≤  
**Session cleanup:** –í—Å–µ —Ñ–ª–∞–≥–∏ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è, process –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ base class  
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** NeuroCrew engine –¥–µ–ª–∞–µ—Ç re-launch –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

#### –¢–∞–±–ª–∏—Ü–∞ 1. OpenCode ACP ‚Äî —Ç–µ–∫—É—â–∞—è vs –æ–∂–∏–¥–∞–µ–º–∞—è —Å–µ—Å—Å–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

| Aspect | Current implementation | Expected / vendor CLI behaviour | Issues & recommendations |
| --- | --- | --- | --- |
| Handshake & auth | `initialize ‚Üí session/new`; `authMethods` —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –Ω–æ `authenticated` —Ñ–ª–∞–≥ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è | CLI `opencode acp` –¥–µ—Ä–∂–∏—Ç —Ç–æ–∫–µ–Ω –ø–æ—Å–ª–µ `opencode login`, runtime-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è | –£—Ç–æ—á–Ω–∏—Ç—å —ç—Ç–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ª–∏–±–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ CLI –∏–∑–º–µ–Ω–∏—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è |
| System prompt & dialogue deltas | `launch()` –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `system_prompt`; –∫–∞–∂–¥–æ–µ `execute()` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–π delta-—Ç–µ–∫—Å—Ç, —Å–æ–±—Ä–∞–Ω–Ω—ã–π –¥–≤–∏–∂–∫–æ–º | ACP –¥–æ–ø—É—Å–∫–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ ‚Äî –∞–≥–µ–Ω—Ç –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ session state | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º; —Å—Ç–æ–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å —é–Ω–∏—Ç-—Ç–µ—Å—Ç, —á—Ç–æ system prompt –ø–æ—Å—ã–ª–∞–µ—Ç—Å—è —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ |
| `_conversation_history` | –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–∞, –±–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π | –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–ª–µ–∑–Ω–æ –≤–∏–¥–µ—Ç—å –ø–∞—Ä—ã `prompt/response` | –õ–∏–±–æ –¥–æ–ø–æ–ª–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤, –ª–∏–±–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–æ–∂–Ω—ã—Ö –æ–∂–∏–¥–∞–Ω–∏–π |
| Timeout & streaming | –ì–ª–æ–±–∞–ª—å–Ω—ã–π `request_timeout` (‚â•5s) + 10s read timeout; –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç `agent_message_chunk` –∏ –ª–æ–≥–∏—Ä—É–µ—Ç `agent_thought_chunk` | CLI –ø–æ—Ç–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ chunk-based, –ø–æ—ç—Ç–æ–º—É –¥–≤–æ–π–Ω–æ–π —Ç–∞–π–º–∞—É—Ç –æ–ø—Ä–∞–≤–¥–∞–Ω | –í—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞—Ç—å —Ç–∞–π–º–∞—É—Ç—ã —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥ —Ä–æ–ª–∏ |
| Reconnect/shutdown | –ü–µ—Ä–µ–¥ `shutdown()` —à–ª—ë—Ç `session/cancel`, –¥–∞–ª–µ–µ SIGTERM/SIGKILL —á–µ—Ä–µ–∑ `BaseConnector`; –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –Ω–µ—Ç | Engine –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ, –µ—Å–ª–∏ `is_alive()` –ª–æ–∂–Ω–æ | –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –±—ç–∫–æ—Ñ—Ñ –∏ –∞–≤—Ç–æ-retry –≤ —Å–∞–º–æ–º –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–µ –¥–ª—è —à—É–º–Ω—ã—Ö CLI |
| Multi-turn continuity | MFA —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ü–µ–ª–∏–∫–æ–º –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ CLI; —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã, –Ω–æ –Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç | ACP-—Å–µ—Å—Å–∏—è –¥–æ–ª–∂–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π | –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º CLI –ª–∏–±–æ —Å–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å stateful mock |

---

### 3.2. Qwen ACP Connector

**–§–∞–π–ª:** `app/connectors/qwen_acp_connector.py`  
**–¢–µ—Å—Ç:** `tests/test_qwen_acp.py`

#### –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç OpenCode

1. **CLI Command:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç `--experimental-acp` –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç

```python
def _prepare_command_args(self, command: str) -> List[str]:
    args = shlex.split(command)
    if not args:
        args = shlex.split(self.DEFAULT_COMMAND)
    
    if "--experimental-acp" not in args:
        args.append("--experimental-acp")
    return args
```

2. **Auth Method:** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É `AUTH_METHOD_QWEN = "qwen-oauth"` (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)

3. **Timeout:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç cap –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ read timeout (min 5s)

```python
message = await asyncio.wait_for(
    self._read_message(),
    timeout=min(remaining, 5.0)  # Cap —á–∏—Ç–∞–π timeout
)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–µ–Ω OpenCode  
**–ü—Ä–æ–±–ª–µ–º—ã:** –¢–µ –∂–µ (auth –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–µ–ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è)  
**–ü–æ–≤–µ–¥–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏:** –ò–¥–µ–Ω—Ç–∏—á–Ω–æ–µ ‚Äî –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

#### –¢–∞–±–ª–∏—Ü–∞ 2. Qwen ACP ‚Äî —Ç–µ–∫—É—â–∞—è vs –æ–∂–∏–¥–∞–µ–º–∞—è —Å–µ—Å—Å–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

| Aspect | Current implementation | Expected / vendor CLI behaviour | Issues & recommendations |
| --- | --- | --- | --- |
| Handshake & auth | `initialize` –∏–∑–≤–ª–µ–∫–∞–µ—Ç `"qwen-oauth"` –≤ `available_auth_methods`, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç | CLI `qwen` –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π login —á–µ—Ä–µ–∑ OAuth (–Ω–∞–ø—Ä., `qwen auth login`) | –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç auth –≤—Ä—É—á–Ω—É—é; –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å fallback –Ω–∞ –ø–æ–∫–∞–∑ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Å—Å–∏–∏ |
| System prompt & dialogue deltas | –ò–¥–µ–Ω—Ç–∏—á–Ω–æ OpenCode: –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ system prompt –≤ `launch()`, –¥–∞–ª–µ–µ —Ç–æ–ª—å–∫–æ delta | ACP-—Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ CLI `qwen --experimental-acp` | –í—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ; —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏—è, —á—Ç–æ `--experimental-acp` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| `_conversation_history` | –ê–∫–∫—É–º—É–ª—è—Ü–∏—è —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤ –∞–≥–µ–Ω—Ç–∞ | –ò–¥–µ–Ω—Ç–∏—á–Ω–æ OpenCode | –¢–æ –∂–µ —Ä–µ—à–µ–Ω–∏–µ: –ª–∏–±–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–∞—Ä–∞–º–∏, –ª–∏–±–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ debug-only |
| Timeout & streaming | `min(remaining, 5.0)` cap –Ω–∞ read timeout; –∏–Ω–∞—á–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ OpenCode | CLI Qwen –∏—Å–ø–æ–ª—å–∑—É–µ—Ç streaming, –∞–Ω–∞–ª–æ–≥–∏—á–Ω—É—é OpenCode | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ; –≤–æ–∑–º–æ–∂–µ–Ω –≤–∞—Ä–∏–∞–Ω—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏ cap-–∑–Ω–∞—á–µ–Ω–∏—è |
| Reconnect/shutdown | –û—Ç–ø—Ä–∞–≤–∫–∞ `session/cancel` –ø–µ—Ä–µ–¥ graceful stop | –¢–æ –∂–µ, —á—Ç–æ OpenCode | –¢–æ –∂–µ: –Ω–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–º–µ—á–∞–Ω–∏–π, –Ω–æ –∞–≤—Ç–æ-retry —É–ª—É—á—à–∏–ª –±—ã UX |
| Multi-turn continuity | –ü–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ server-side session | CLI-–∞–≥–µ–Ω—Ç Qwen –æ–±—è–∑–∞–Ω —Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ø–æ–∫–∞ —Å–µ—Å—Å–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ | –î–æ–±–∞–≤–∏—Ç—å live integration test, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è Qwen CLI |

---

### 3.3. Gemini ACP Connector

**–§–∞–π–ª:** `app/connectors/gemini_acp_connector.py`  
**–¢–µ—Å—Ç:** `tests/test_gemini_acp.py`

#### –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è

1. **Enhanced Error Handling:**

```python
if isinstance(error, dict) and "data" in error:
    data = error["data"]
    if isinstance(data, dict) and "details" in data:
        error_message += f" Details: {data['details']}"
    else:
        error_message += f" Data: {data}"
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

2. **Copy-Paste Bug:**

```python
# Line 377 –≤ _write_message:
raise RuntimeError("Qwen ACP process stdin is not available.")  # ‚ùå –î–û–õ–ñ–ù–û –ë–´–¢–¨ "Gemini"
```

**–°—Ç–∞—Ç—É—Å:** üêõ –ú–∏–Ω–æ—Ä–Ω—ã–π –±–∞–≥ ‚Äî –Ω–µ–≤–µ—Ä–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ  
**–í–ª–∏—è–Ω–∏–µ:** –ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–æ–µ, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ "Gemini ACP process stdin is not available."

#### –¢–∞–±–ª–∏—Ü–∞ 3. Gemini ACP ‚Äî —Ç–µ–∫—É—â–∞—è vs –æ–∂–∏–¥–∞–µ–º–∞—è —Å–µ—Å—Å–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

| Aspect | Current implementation | Expected / vendor CLI behaviour | Issues & recommendations |
| --- | --- | --- | --- |
| Handshake & auth | –¢–æ –∂–µ, —á—Ç–æ —É –¥—Ä—É–≥–∏—Ö –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤; —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `gemini-api-key` –∏–∑ —Å–ø–∏—Å–∫–∞ auth methods | CLI `gemini` —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π `gemini login` / –≤–≤–æ–¥ API-–∫–ª—é—á–∞ | –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ README —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ log-in; –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è |
| System prompt & dialogue deltas | –ò–¥–µ–Ω—Ç–∏—á–Ω–æ: system prompt –æ–¥–∏–Ω —Ä–∞–∑, –¥–∞–ª–µ–µ —Ç–æ–ª—å–∫–æ delta | Gemini ACP CLI (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π) —Å—Ç—Ä–æ–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ sessionId | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –µ—Å—Ç—å; —Å—Ç–æ–∏—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º CLI –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∞–ø–¥–µ–π—Ç–µ beta |
| `_conversation_history` | –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–∞ | –¢–æ –∂–µ | –¢–µ –∂–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —á—Ç–æ –∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤ |
| Timeout & streaming | –°–æ–≤–ø–∞–¥–∞–µ—Ç —Å OpenCode; –Ω–µ—Ç cap –Ω–∞ read timeout, –∑–∞—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ | Gemini CLI –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `error.data.details`, –ø–æ—ç—Ç–æ–º—É —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø—Ä–∞–≤–¥–∞–Ω–æ | –í—Å—ë –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ; –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã |
| Reconnect/shutdown | –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞ `session/cancel` + graceful shutdown | –¢–æ –∂–µ | –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–≤—Ç–æ-retry/health-check, —Ç.–∫. CLI beta –º–µ–Ω–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–∞ |
| Multi-turn continuity | –ü–æ–ª–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç sessionId | Gemini CLI —Ö—Ä–∞–Ω–∏—Ç –∏—Å—Ç–æ—Ä–∏—é –≤ –æ–±–ª–∞–∫–µ | –î–æ–±–∞–≤–∏—Ç—å smoke-—Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º CLI, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–¥–∏—Ç—å —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ beta |
| Error messaging | –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–æ copy-paste –±–∞–≥ —Å "Qwen" | –û–∂–∏–¥–∞–µ—Ç—Å—è "Gemini" –≤–æ –≤—Å–µ—Ö –ª–æ–≥–∞—Ö | –ë–∞–≥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –≤ –∫–æ–¥–µ –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ —Ç–∏–∫–µ—Ç–∞ |

---

## 4. –ê–Ω–∞–ª–∏–∑ —Ç–µ—Å—Ç–æ–≤ –∏ –æ–∂–∏–¥–∞–Ω–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞

### 4.1. Mock Server Pattern

–í—Å–µ —Ç—Ä–∏ —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω mock-—Å–µ—Ä–≤–µ—Ä–∞:

```python
# Mock —Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç stdin –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ stdout
while True:
    message = await read_line(reader)
    
    if method == "initialize":
        # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç capabilities –∏ authMethods
    elif method == "session/new":
        # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π sessionId
    elif method == "session/prompt":
        # Echo back –ø—Ä–æ–º–ø—Ç –≤ session/update chunks
        # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç result —Å stopReason
```

**–í–∞–∂–Ω–æ:** Mock-—Å–µ—Ä–≤–µ—Ä—ã **–ù–ï** –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É `session/prompt` –≤—ã–∑–æ–≤–∞–º–∏  
**–ü—Ä–∏—á–∏–Ω–∞:** –û–Ω–∏ –ø—Ä–æ—Å—Ç–æ —ç—Ö–æ-–æ—Ç–≤–µ—á–∞—é—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç

### 4.2. Multi-Turn Test

```python
user_prompt = "Write hello world."
response = await connector.execute(user_prompt)
assert response == f"Mock response to: {user_prompt}"

follow_up_prompt = "And add tests."
follow_up = await connector.follow_up(follow_up_prompt)
assert follow_up == f"Mock response to: {follow_up_prompt}"

history = connector.get_session_history()
assert history == [response, follow_up]
```

**–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**  
‚úÖ –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ `execute()` —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–æ–π –∂–µ —Å–µ—Å—Å–∏–µ–π  
‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±–∞ –æ—Ç–≤–µ—Ç–∞  

**–ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**  
‚ùå CLI-–∞–≥–µ–Ω—Ç –ø–æ–º–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (mock server –Ω–µ –∏–º–µ–µ—Ç –ø–∞–º—è—Ç–∏)  
‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –ø—Ä–æ–º–ø—Ç–µ (–∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é)

**–í—ã–≤–æ–¥:** –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç **–º–µ—Ö–∞–Ω–∏–∫—É –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞**, –Ω–æ –Ω–µ **–ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ CLI-–∞–≥–µ–Ω—Ç–∞**

---

## 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å NeuroCrew Engine

### 5.1. –ö–∞–∫ Engine –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã

```python
# app/core/engine.py:557
response = await asyncio.wait_for(
    role_connector.execute(role_prompt),
    timeout=self.request_timeout
)
```

**–ß—Ç–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `execute()`:**  
- `role_prompt` = —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è NEW messages —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Ä–æ–ª–∏
- –§–æ—Ä–º–∞—Ç: `"User: {text}\n\nAssistant (Role): {response}\n\n..."`

### 5.2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```python
# engine.py:628-684
def _format_conversation_for_role(self, new_messages, role, chat_id):
    for msg in filtered_messages:
        if msg.get("role") == "user":
            context_lines.append(f"User: {content}")
        elif msg.get("role") == "agent":
            agent_name = msg.get("role_display_name", ...)
            context_lines.append(f"Assistant ({agent_name}): {content}")
    
    conversation_context = "\n\n".join(context_lines)
    # –°–∏—Å—Ç–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∫–∞–∂–¥—ã–µ N –æ—Ç–≤–µ—Ç–æ–≤
    if response_count % Config.SYSTEM_REMINDER_INTERVAL == 0:
        conversation_context = system_reminder + conversation_context
    
    return conversation_context, True
```

**–ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:**  
1. Engine –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç `role_last_seen_index[chat_id, role_name]`  
2. –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –ø–æ–ª—É—á–∞–µ—Ç –¥–µ–ª—å—Ç—É: `conversation[last_seen_index:]`  
3. –î–µ–ª—å—Ç–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π prompt  
4. –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¢–û–õ–¨–ö–û —ç—Ç–æ—Ç prompt –≤ CLI  
5. CLI-–∞–≥–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å–∞–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å session context

**–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç ACP:** CLI-–∞–≥–µ–Ω—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –≤–Ω—É—Ç—Ä–∏ `sessionId` –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ—ë –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—É—é –¥–µ–ª—å—Ç—É.

---

## 6. –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 6.1. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (CURRENT)

| –ê—Å–ø–µ–∫—Ç | OpenCode | Qwen | Gemini | –û—Ü–µ–Ω–∫–∞ |
|--------|----------|------|--------|--------|
| Handshake (initialize) | ‚úÖ | ‚úÖ | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| Session Creation (session/new) | ‚úÖ | ‚úÖ | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| Prompt Transmission | ‚úÖ | ‚úÖ | ‚úÖ | –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| Authentication Usage | ‚ùå | ‚ùå | ‚ùå | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| Conversation History | ‚ö†Ô∏è | ‚ö†Ô∏è | ‚ö†Ô∏è | –¢–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã |
| Context Replay | N/A | N/A | N/A | –ü–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ CLI |
| Timeout Handling | ‚úÖ | ‚úÖ | ‚úÖ | –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π |
| Reconnect Logic | ‚ùå | ‚ùå | ‚ùå | Manual restart |
| Shutdown & Cleanup | ‚úÖ | ‚úÖ | ‚úÖ | Graceful |
| Streaming | ‚úÖ | ‚úÖ | ‚úÖ | Chunk aggregation |
| Error Reporting | ‚úÖ | ‚úÖ | ‚≠ê | Gemini –ª—É—á—à–µ |

### 6.2. –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (EXPECTED per ACP)

| –ê—Å–ø–µ–∫—Ç | –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è ACP | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ |
|--------|------------------|------------|--------------|
| Session State | CLI-–∞–≥–µ–Ω—Ç —Ö—Ä–∞–Ω–∏—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ sessionId | –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é | ‚úÖ |
| Multi-turn Continuity | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ session | –ü–æ–ª–∞–≥–∞–µ—Ç—Å—è –Ω–∞ CLI-–∞–≥–µ–Ω—Ç | ‚úÖ |
| Authentication | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –∏–∑ initialize | –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (CLI pre-auth) | ‚ö†Ô∏è |
| Client History | –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É | –ù–µ–ø–æ–ª–Ω–∞—è (—Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã) | ‚ö†Ô∏è |
| Reconnect | –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –≤ ACP | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | ‚ö†Ô∏è |

### 6.3. –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### üêõ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (0)

–ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º.

#### ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ (2)

1. **–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**  
   - **–ì–¥–µ:** –í—Å–µ —Ç—Ä–∏ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞  
   - **–ü—Ä–æ–±–ª–µ–º–∞:** `available_auth_methods` –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è  
   - **–ü—Ä–∏—á–∏–Ω–∞:** CLI-–∞–≥–µ–Ω—Ç—ã pre-authenticated –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º  
   - **–†–µ—à–µ–Ω–∏–µ:** –õ–∏–±–æ —É–¥–∞–ª–∏—Ç—å –∫–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –ª–∏–±–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –±—É–¥—É—â–µ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ

2. **–ù–µ–ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞**  
   - **–ì–¥–µ:** `_conversation_history` –≤–æ –≤—Å–µ—Ö –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞—Ö  
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç—ã –∞–≥–µ–Ω—Ç–∞, –Ω–µ –ø—Ä–æ–º–ø—Ç—ã  
   - **–í–ª–∏—è–Ω–∏–µ:** `get_session_history()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É  
   - **–†–µ—à–µ–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–∞—Ä—ã `(prompt, response)` –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å feature –µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

#### üîß –ú–∏–Ω–æ—Ä–Ω—ã–µ (2)

3. **Copy-paste bug –≤ Gemini**  
   - **–ì–¥–µ:** `gemini_acp_connector.py:377`  
   - **–ü—Ä–æ–±–ª–µ–º–∞:** "Qwen ACP process" –≤–º–µ—Å—Ç–æ "Gemini ACP process"  
   - **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É –æ—à–∏–±–∫–∏

4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ reconnect**  
   - **–ì–¥–µ:** –í—Å–µ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã  
   - **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω—É–∂–µ–Ω manual re-launch  
   - **–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** Engine –¥–µ–ª–∞–µ—Ç `launch()` –µ—Å–ª–∏ `is_alive() == False`  
   - **–†–µ—à–µ–Ω–∏–µ:** –¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è MVP, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø–æ–∑–∂–µ

### 6.4. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

#### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (MVP)

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å copy-paste bug –≤ Gemini:**
   ```python
   # gemini_acp_connector.py:377
   - raise RuntimeError("Qwen ACP process stdin is not available.")
   + raise RuntimeError("Gemini ACP process stdin is not available.")
   ```

2. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ —Ç–æ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è CLI-–∞–≥–µ–Ω—Ç–æ–º
   - –Ø–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ `_conversation_history` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è debugging

3. **–£–ª—É—á—à–∏—Ç—å —Ç–µ—Å—Ç—ã:**
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ—è—Å–Ω–µ–Ω–∏–µ, —á—Ç–æ mock server –Ω–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–Ω—É—é –ø–∞–º—è—Ç—å
   - –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º CLI-–∞–≥–µ–Ω—Ç–æ–º (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

#### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ (Post-MVP)

4. **–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫:**
   - –ü–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–Ω—ã–π error handling –∏–∑ Gemini –≤ OpenCode –∏ Qwen

5. **–†–µ—à–∏—Ç—å —Å—É–¥—å–±—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
   - –õ–∏–±–æ —É–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥ (`available_auth_methods`)
   - –õ–∏–±–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

6. **–£–ª—É—á—à–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–ª–∏–µ–Ω—Ç–∞:**
   - –°–æ—Ö—Ä–∞–Ω—è—Ç—å `List[Tuple[prompt, response]]` –≤–º–µ—Å—Ç–æ `List[response]`
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫

#### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (Future)

7. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å reconnect –ª–æ–≥–∏–∫—É:**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ `BrokenPipeError`
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å replay –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

8. **Session persistence:**
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ `sessionId` –≤ storage
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ—Å–ª–µ restart –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

## 7. –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è ACP

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | OpenCode | Qwen | Gemini |
|-----------|----------|------|--------|
| JSON-RPC 2.0 protocol | ‚úÖ | ‚úÖ | ‚úÖ |
| `initialize` request | ‚úÖ | ‚úÖ | ‚úÖ |
| Client capabilities | ‚úÖ | ‚úÖ | ‚úÖ |
| Auth methods discovery | ‚úÖ | ‚úÖ | ‚úÖ |
| `session/new` request | ‚úÖ | ‚úÖ | ‚úÖ |
| Session ID tracking | ‚úÖ | ‚úÖ | ‚úÖ |
| `session/prompt` request | ‚úÖ | ‚úÖ | ‚úÖ |
| Prompt content blocks | ‚úÖ | ‚úÖ | ‚úÖ |
| `session/update` notifications | ‚úÖ | ‚úÖ | ‚úÖ |
| Chunk aggregation | ‚úÖ | ‚úÖ | ‚úÖ |
| Stop reason handling | ‚úÖ | ‚úÖ | ‚úÖ |
| `session/cancel` notification | ‚úÖ | ‚úÖ | ‚úÖ |
| Error propagation | ‚úÖ | ‚úÖ | ‚úÖ |
| Bidirectional requests | ‚úÖ | ‚úÖ | ‚úÖ |
| Permission auto-grant | ‚úÖ | ‚úÖ | ‚úÖ |

**–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:** **üü¢ –ü–æ–ª–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ACP 0.1.4**

---

## 8. –ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã **–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** –¥–ª—è ACP-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:

1. **Stateful Sessions:** –ü—Ä–æ—Ü–µ—Å—Å CLI-–∞–≥–µ–Ω—Ç–∞ –∂–∏–≤–µ—Ç –º–µ–∂–¥—É –ø—Ä–æ–º–ø—Ç–∞–º–∏
2. **Server-Side Context:** –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ CLI-–∞–≥–µ–Ω—Ç–µ, –Ω–µ –≤ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–µ
3. **Thin Client:** –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä ‚Äî —ç—Ç–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –Ω–µ –º–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
4. **Engine Integration:** NeuroCrew Engine —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

### –ú—É–ª—å—Ç–∏—Ç—É—Ä–Ω–æ–≤–∞—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
- Engine –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –≤ `FileStorage`
- Engine —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –¥–µ–ª—å—Ç—É –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏
- –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –ø–µ—Ä–µ–¥–∞–µ—Ç –¥–µ–ª—å—Ç—É –≤ CLI-–∞–≥–µ–Ω—Ç–∞
- CLI-–∞–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ—é —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Å–µ—Å—Å–∏—é –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏

**–ì–∞—Ä–∞–Ω—Ç–∏–∏:**
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏ `execute()` –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏
- ‚úÖ –†–æ–ª—å –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã –∏ –æ—Ç–≤–µ—Ç—ã –¥—Ä—É–≥–∏—Ö —Ä–æ–ª–µ–π
- ‚úÖ Session ID –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É –∫ –æ–¥–Ω–æ–º—É CLI-–ø—Ä–æ—Ü–µ—Å—Å—É
- ‚ö†Ô∏è –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ restart –ø—Ä–æ—Ü–µ—Å—Å–∞ (–Ω–æ —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º–æ)

### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

- **1 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥:** –ù–µ—Ç
- **2 –≤–∞–∂–Ω—ã—Ö –Ω–µ–¥–æ—á–µ—Ç–∞:** –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è auth, –Ω–µ–ø–æ–ª–Ω–∞—è –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è (–Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)
- **2 –º–∏–Ω–æ—Ä–Ω—ã—Ö –±–∞–≥–∞:** Copy-paste –≤ Gemini, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ reconnect (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è MVP)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å "Qwen" ‚Üí "Gemini" –≤ –æ—à–∏–±–∫–µ
2. **–î–æ —Ä–µ–ª–∏–∑–∞ MVP:** –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
3. **Post-MVP:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å error handling, —É–ª—É—á—à–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
4. **Future:** Reconnect –ª–æ–≥–∏–∫–∞, session persistence

---

**–ê–≤—Ç–æ—Ä:** AI Audit System  
**–î–∞—Ç–∞:** 2024  
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
