# ü§ñ Telegram-–±–æ—Ç NeuroCrew Lab

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Telegram-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

NeuroCrew Lab –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Puppet Master** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å –¥–≤—É–º—è —Ç–∏–ø–∞–º–∏ –±–æ—Ç–æ–≤:

1. **Listener Bot** - –æ–¥–∏–Ω –±–æ—Ç-—Å–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –ø—Ä–∏–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
2. **Actor Bots** - –æ—Ç–¥–µ–ª—å–Ω—ã–µ –±–æ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è—é—â–∏–µ –æ—Ç–≤–µ—Ç—ã

```
User ‚Üí Target Chat ‚Üí Listener Bot ‚Üí NeuroCrew Core ‚Üí Actor Bots ‚Üí Target Chat
```

## Listener Bot

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

- **–ü—Ä–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π** —Ç–æ–ª—å–∫–æ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ `TARGET_CHAT_ID`
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥** - `/start`, `/help`, `/reset`, `/status`, `/metrics`, `/agents`, `/next`, `/about`
- **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è** - –ø–µ—Ä–µ–¥–∞—á–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ NeuroCrewLab –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **Fallback –æ—Ç–ø—Ä–∞–≤–∫–∞** - –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–∞ actor-–±–æ—Ç–∞

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```bash
# .env —Ñ–∞–π–ª
MAIN_BOT_TOKEN=1234567890:ABCDEF...  # –¢–æ–∫–µ–Ω listener-–±–æ—Ç–∞
TARGET_CHAT_ID=-1001234567890        # ID —Ü–µ–ª–µ–≤–æ–≥–æ —á–∞—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram

1. **–°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather:**
   ```
   /newbot
   NeuroCrew Listener
   ncrew_listener_bot
   ```

2. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞** - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω –≤ `.env`

3. **–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:**
   - –°–æ–∑–¥–∞—Ç—å Telegram-–≥—Ä—É–ø–ø—É
   - –î–æ–±–∞–≤–∏—Ç—å listener-–±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É
   - –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ—Ö actor-–±–æ—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø—É

4. **–û—Ç–∫–ª—é—á–µ–Ω–∏–µ Privacy Mode:**
   ```
   @BotFather ‚Üí /mybots ‚Üí NeuroCrew Listener ‚Üí Bot Settings ‚Üí Group Privacy ‚Üí Turn off
   ```

5. **–ü–æ–ª—É—á–µ–Ω–∏–µ Chat ID:**
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É
   - –ü–µ—Ä–µ—Å–ª–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ @userinfobot
   - –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å `chat_id` –≤ `.env`

## Actor Bots

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

- **–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤** –æ—Ç –∏–º–µ–Ω–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–æ–ª–∏
- **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å** - –∫–∞–∂–¥—ã–π –±–æ—Ç –∏–º–µ–µ—Ç —Å–≤–æ–π —Ç–æ–∫–µ–Ω –∏ –∏–º—è
- **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å MarkdownV2
- **Graceful fallback** - –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è listener-–±–æ—Ç

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–î–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏ –≤ `roles/agents.yaml`:

```yaml
- role_name: software_developer
  display_name: "Software Developer"
  telegram_bot_name: Software_Dev_Bot    # –ò–º—è –±–æ—Ç–∞
  agent_type: gemini_acp
  cli_command: "gemini --experimental-acp"
```

–¢–æ–∫–µ–Ω –∏—â–µ—Ç—Å—è –≤ `.env` –ø–æ —à–∞–±–ª–æ–Ω—É:
```bash
SOFTWARE_DEV_BOT_TOKEN=1234567890:GHIJKL...
```

### –°–æ–∑–¥–∞–Ω–∏–µ Actor Bots

–î–ª—è –∫–∞–∂–¥–æ–π —Ä–æ–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather:

```
/newbot
Software Developer Bot
software_dev_bot
```

–ò–º–µ–Ω–∞ –±–æ—Ç–æ–≤ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ–ª—é `telegram_bot_name` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

## –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### /start
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `/start`
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NeuroCrewLab

### /help
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º
**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `/help`
**–î–µ–π—Å—Ç–≤–∏—è:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥
- –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### /reset
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–∞—Ç–∞ –∏ —Å–µ—Å—Å–∏–π
**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `/reset`
**–î–µ–π—Å—Ç–≤–∏—è:**
- –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
- –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö CLI-—Å–µ—Å—Å–∏–π
- –°–±—Ä–æ—Å —É–∫–∞–∑–∞—Ç–µ–ª–µ–π —Ä–æ–ª–µ–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

### /status
**–û–ø–∏—Å–∞–Ω–∏–µ:** –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `/status`
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–æ–ª–µ–π
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã

### /metrics
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `/metrics`
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ —Ä–æ–ª—è–º
- –í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤
- –°—á–µ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫ –∏ retry
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏

### /agents
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å—ã
**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `/agents`
**–î–µ–π—Å—Ç–≤–∏—è:**
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–æ–ª–µ–π
- –°—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞
- –¢–∏–ø –∞–≥–µ–Ω—Ç–∞ –∏ CLI –∫–æ–º–∞–Ω–¥–∞

### /next
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Ä–æ–ª–∏
**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `/next`
**–î–µ–π—Å—Ç–≤–∏—è:**
- –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ä–æ–ª–∏
- –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### /about
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ –∏ –≤–µ—Ä—Å–∏–∏
**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** `/about`
**–î–µ–π—Å—Ç–≤–∏—è:**
- –í–µ—Ä—Å–∏—è NeuroCrew Lab
- –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

## –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

### –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏

1. **–ü—Ä–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è:**
   ```python
   async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       message = update.message
       chat_id = message.chat_id
   ```

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è —á–∞—Ç–∞:**
   ```python
   if chat_id != Config.TARGET_CHAT_ID:
       return  # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –¥—Ä—É–≥–∏—Ö —á–∞—Ç–æ–≤
   ```

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥:**
   ```python
   if message.text.startswith('/'):
       await self._handle_command(message)
       return
   ```

4. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é:**
   ```python
   await self.storage.add_message(
       chat_id=chat_id,
       role_name="user",
       content=message.text,
       message_type="user_message"
   )
   ```

5. **–ü–µ—Ä–µ–¥–∞—á–∞ –≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä:**
   ```python
   async for response in self.ncrew.handle_message(chat_id, message.text):
       await self._send_response(chat_id, response)
   ```

### –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤

#### –í—ã–±–æ—Ä actor-–±–æ—Ç–∞
```python
async def _send_role_messages_via_actor(self, chat_id: int, role_name: str, messages: List[str]):
    role = Config.get_role_config(role_name)
    bot_token = role.get_bot_token()
    
    if bot_token:
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å actor-–±–æ—Ç–∞
        bot = Bot(token=bot_token)
    else:
        # Fallback –Ω–∞ listener-–±–æ—Ç–∞
        bot = self.bot
```

#### –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
```python
async def _send_message(self, bot: Bot, chat_id: int, text: str):
    # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ MarkdownV2
    escaped_text = escape_markdown(text, version=2)
    
    await bot.send_message(
        chat_id=chat_id,
        text=escaped_text,
        parse_mode=ParseMode.MARKDOWN_V2
    )
```

## MarkdownV2 —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞—á–µ–º –Ω—É–∂–Ω–æ MarkdownV2

- **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞** - –∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤, –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å–ø–∏—Å–∫–∏, —Å—Å—ã–ª–∫–∏, –∫–æ–¥
- **–ò–∑–±–µ–∂–∞–Ω–∏–µ –æ—à–∏–±–æ–∫** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤

### –ü—Ä–∞–≤–∏–ª–∞ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–æ–ª–∂–Ω—ã —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –æ–±—Ä–∞—Ç–Ω—ã–º —Å–ª—ç—à–µ–º:
```
_ * [ ] ( ) ~ ` > # + - = | { } . !
```

### –ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

```python
# –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
**Bold text**

# –ö—É—Ä—Å–∏–≤
*Italic text*

# –ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π
`Code snippet`

# –°—Å—ã–ª–∫–∞
[Google](https://google.com)

# –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
Hello\_world!  # –í–º–µ—Å—Ç–æ Hello_world!
```

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

```python
from telegram.helpers import escape_markdown

def format_response(text: str) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è Telegram."""
    # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
    escaped = escape_markdown(text, version=2)
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    formatted = f"üí¨ {escaped}"
    
    return formatted
```

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NeuroCrewLab

```python
async def _ensure_ncrew_initialized(self):
    """–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NeuroCrewLab."""
    if self.ncrew is None:
        self.ncrew = NeuroCrewLab(storage=self.storage)
        await self.ncrew.initialize()
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏

```python
async def _handle_reset_command(self, chat_id: int):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /reset."""
    if self.ncrew:
        await self.ncrew.shutdown_role_sessions(chat_id)
    
    # –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
    await self.storage.clear_conversation(chat_id)
    
    await self.bot.send_message(
        chat_id=chat_id,
        text="üîÑ –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–∞—Ç–∞ —Å–±—Ä–æ—à–µ–Ω–æ"
    )
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫

1. **Telegram API –æ—à–∏–±–∫–∏**
   - –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤
   - –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–≤

2. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏**
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `TARGET_CHAT_ID`
   - –ù–µ–≤–µ—Ä–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –±–æ—Ç–æ–≤
   - –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–æ–ª–µ–π

3. **–û—Ä–∫–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏**
   - –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤
   - –¢–∞–π–º–∞—É—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
   - –û—à–∏–±–∫–∏ CLI

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

```python
async def safe_send_message(self, bot: Bot, chat_id: int, text: str):
    """–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    try:
        await bot.send_message(chat_id=chat_id, text=text)
    except Forbidden as e:
        logger.error(f"Bot forbidden to send messages: {e}")
    except ChatNotFound as e:
        logger.error(f"Chat not found: {e}")
    except TelegramError as e:
        logger.error(f"Telegram error: {e}")
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
logger = get_logger("TelegramBot")

async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.info(
        "Message received",
        extra={
            "chat_id": update.message.chat_id,
            "user_id": update.message.from_user.id,
            "message_length": len(update.message.text),
            "is_command": update.message.text.startswith('/')
        }
    )
```

### –ú–µ—Ç—Ä–∏–∫–∏

- `telegram_messages_received` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `telegram_messages_sent` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- `telegram_commands_processed` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- `telegram_errors` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ Telegram API

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```python
from app.utils.security import sanitize_message, validate_message_length

async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = update.message.text
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã
    if not validate_message_length(message):
        await self.bot.send_message(
            chat_id=update.message.chat_id,
            text="‚ùå –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
        )
        return
    
    # –û—á–∏—Å—Ç–∫–∞ –æ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    clean_message = sanitize_message(message)
```

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞

- **–¢–æ–ª—å–∫–æ —Ü–µ–ª–µ–≤–æ–π —á–∞—Ç** - –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –¥—Ä—É–≥–∏—Ö —á–∞—Ç–æ–≤
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤** - –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∞–≤ –±–æ—Ç–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
- **Rate limiting** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ó–∞—â–∏—Ç–∞ –æ—Ç –∏–Ω—ä–µ–∫—Ü–∏–π

- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ MarkdownV2
- –û—á–∏—Å—Ç–∫–∞ HTML-—Ç–µ–≥–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit-—Ç–µ—Å—Ç—ã

```python
import pytest
from unittest.mock import Mock, AsyncMock
from app.interfaces.telegram_bot import TelegramBot

@pytest.mark.asyncio
async def test_handle_command_start():
    """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã /start."""
    mock_update = Mock()
    mock_update.message.text = "/start"
    mock_update.message.chat_id = 12345
    
    mock_bot = AsyncMock()
    
    telegram_bot = TelegramBot()
    telegram_bot.bot = mock_bot
    
    await telegram_bot._handle_command(mock_update.message)
    
    mock_bot.send_message.assert_called_once()
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

```python
@pytest.mark.asyncio
async def test_message_flow():
    """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è."""
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —á–∞—Ç–∞
    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç actor-–±–æ—Ç–∞
    pass
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥

```python
@pytest.mark.parametrize("command,expected_response", [
    ("/start", "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å"),
    ("/help", "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã"),
    ("/reset", "–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ"),
])
async def test_commands(command, expected_response):
    """–¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥."""
    pass
```