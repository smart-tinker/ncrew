# Архитектура MVP ncrew

Документ описывает целевую архитектуру минимально жизнеспособной версии ncrew. Уровень детализации рассчитан на дальнейшее расширение без радикальных изменений.

## Общий обзор
```
┌──────────────────────────┐
│        TUI Shell         │
│ ┌────────┬─────────────┐ │
│ │ Layout │ Input/Output│ │
│ └────────┴─────────────┘ │
└────────────┬─────────────┘
             │ события/состояние
┌────────────▼─────────────┐
│   Session Coordinator    │
│ ┌────────────┬─────────┐ │
│ │ Agent Pool │ Message │ │
│ │            │ Router  │ │
│ └────────────┴─────────┘ │
└────────────┬─────────────┘
             │ процессы/IO
┌────────────▼─────────────┐
│   CLI Adapter Layer      │
│ ┌──────┬──────┬──────┬───│
│ │Claude│Codex │Gemini│...│
│ └──────┴──────┴──────┴───│
└──────────────────────────┘
```

## Основные компоненты

### 1. TUI Shell
- Построен на Python с использованием [Textual](https://github.com/Textualize/textual).
- Обеспечивает:
  - отображение списка участников чата и текущего статуса выполнения;
  - общую историю сообщений с пометкой источника;
  - поле ввода и индикаторы статуса (активность, ошибки запуска процесса);
  - горячие клавиши (отправка `Enter`, обновление настроек `Ctrl+R`, открытие справки `?`).
- Работает с реактивной моделью: состояние хранится в Session Coordinator, Shell подписывается на события.

### 2. Session Coordinator
- Центральный модуль, отвечающий за управление агентами и доставку сообщений.
- Подсостав:
  - **Agent Pool** — реестр подключённых CLI-агентов с метаданными (имя, команда запуска, статус и позиция в очереди ответа).
  - **Message Router** — очередь событий для входящих/исходящих сообщений, обеспечивает сохранение истории, трансляцию в TUI и
    гарантирует последовательную обработку ответов.
- Обеспечивает последовательную рассылку сообщений всему составу, перезапуск агентов и обновление состояния TUI.
- Хранит путь к файлу настроек и предоставляет методы загрузки/сохранения.

### 3. CLI Adapter Layer
- Абстракция для запуска внешних CLI-инструментов как подпроцессов.
- Каждому агенту соответствует адаптер, использующий `subprocess.run` для формирования вызова.
- Для MVP используется одиночный вызов на каждый запрос и построение аргументов либо добавлением сообщения в конец команды, либо
  подстановкой `{message}` в шаблон. Адаптеры вызываются последовательно в порядке, заданном конфигурацией.
- Обрабатывает ошибки запуска (например, отсутствие бинаря) и уведомляет Session Coordinator, не прерывая цепочку остальных агентов.

## Потоки данных
1. Пользователь вводит сообщение → TUI Shell передаёт его Session Coordinator.
2. Coordinator формирует очередь запросов для всех агентов в порядке, указанном в конфигурации.
3. Для каждого агента последовательно вызывается адаптер, который отправляет команду внешнему CLI-процессу и читает ответ.
4. Ответы возвращаются в Router, который добавляет их в историю с пометкой источника и публикует событие в TUI.
5. История сообщений хранится в памяти, опционально может быть выгружена в лог-файл (за пределами MVP).

## Конфигурация
- Настройки хранятся в `~/.ncrew/settings.json`.
- Структура файла (черновик):
```json
{
  "agents": [
    {
      "id": "claude",
      "name": "Claude Code",
      "command": "claude-code chat"
    },
    {
      "id": "codex",
      "name": "OpenAI Codex",
      "command": "codex \"say hello!\""
    }
  ],
  "ui": {
    "theme": "default",
    "history_limit": 200
  }
}
```
- Coordinator отвечает за валидацию и инициализацию каталога `~/.ncrew`.
- Порядок агентов в массиве `agents` определяет последовательность их ответов в групповом диалоге.

## Расширения после MVP
- История сообщений на диск и поиск.
- Дополнительные горячие клавиши и контекстные действия (редактирование промпта, broadcast нескольким агентам).
- Поддержка параллельного выполнения запросов и отображения статуса загрузки.
- Интеграция с аналитикой (сводка, голосование).
