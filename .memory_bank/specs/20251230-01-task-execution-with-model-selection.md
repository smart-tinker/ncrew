# Спецификация: Выполнение задачи с выбором модели

**Имя:** Task Execution with Model Selection  
**Дата:** 2025-12-30  
**Версия:** 1.0  
**Статус:** Draft  

## Обзор

Фича позволяет запускать выполнение задач через AI-агента с возможностью выбора модели. Список моделей получается из команды `opencode models`, кешируется на 24 часа. Модель выбирается при запуске задачи и сохраняется во фронтматтере файла задачи.

## User Stories

### US-2.1: Получение списка моделей
Как **Разработчик**, я хочу видеть список доступных моделей в UI, чтобы выбрать подходящую для выполнения задачи.

### US-2.2: Кеширование списка моделей
Как **Разработчик**, я хочу, чтобы список моделей кешировался на 24 часа с возможностью принудительного обновления, чтобы избежать лишних вызовов `opencode models`.

### US-2.3: Дефолтная модель проекта
Как **Разработчик**, я хочу задать дефолтную модель для проекта, чтобы не выбирать её каждый раз.

### US-2.4: Выбор модели для задачи
Как **Разработчик**, я хочу выбрать модель для конкретной задачи в карточке задачи или при запуске, чтобы переопределить дефолтную модель проекта.

### US-2.5: Сохранение модели задачи
Как **Разработчик**, я хочу, чтобы выбранная модель сохранялась во фронтматтере задачи, чтобы при следующем открытии карточки показывать сохранённый выбор.

### US-2.6: Запуск задачи
Как **Разработчик**, я хочу запустить выполнение задачи через `opencode`, который читает описание задачи из файла и выполняет её.

## Требования

### Функциональные требования

#### 1. Список моделей (Models List)

**1.1. Получение списка**
- Выполняется команда `opencode models`
- Парсится вывод команды для получения списка моделей
- Формат каждой модели: `<provider>/<model-name>`
  - Пример: `opencode/claude-sonnet-4-5`
  - Пример: `zai-coding-plan/glm-4.6`

**1.2. Кеширование**
- Список моделей кешируется на 24 часа
- Время последнего обновления хранится в кеше
- При запросе списка:
  - Если кеш актуален (менее 24 часов) - возвращается из кеша
  - Если кеш устарел - обновляется и возвращается новый список

**1.3. Принудительное обновление**
- Добавляется кнопка "Refresh models"
- При нажатии:
  - Восстанавливается из кеша (для быстрого отображения)
  - Выполняется команда `opencode models` в фоне
  - Обновляется список в UI по завершении команды

**1.4. Структура модели**
```typescript
interface Model {
  provider: string;        // например, "opencode"
  name: string;            // например, "claude-sonnet-4-5"
  fullName: string;        // например, "opencode/claude-sonnet-4-5"
}
```

#### 2. Дефолтная модель проекта (Default Project Model)

**2.1. Хранение**
- Добавляется в конфигурацию проекта:
```json
{
  "id": "proj-123",
  "name": "my-app",
  "path": "/home/dev/my-app",
  "defaultModel": {
    "agenticHarness": "opencode",
    "modelProvider": "opencode",
    "modelName": "claude-sonnet-4-5"
  }
}
```

**2.2. Значение по умолчанию**
- Если дефолтная модель не задана - используется первая модель из списка

**2.3. Валидация**
- При сохранении проекта проверяется, что выбранная модель существует в списке моделей

#### 3. Модель задачи (Task Model)

**3.1. Фронтматтер**
Добавляется в MD-файл задачи:
```yaml
---
title: Task name
status: New
priority: High
agenticHarness: opencode
modelProvider: opencode
modelName: claude-sonnet-4-5
---
```

**3.2. Значение по умолчанию**
- Если модель не указана во фронтматтере - используется дефолтная модель проекта
- При сохранении модели в UI - записывается во фронтматтер

**3.3. Парсинг**
- При чтении файла задачи извлекаются поля:
  - `agenticHarness`
  - `modelProvider`
  - `modelName`
- Если поля отсутствуют - используется значение из конфигурации проекта

#### 4. UI для выбора модели

**4.1. Выбор модели в карточке задачи**
- Добавляется поле "Model" в карточку задачи
- Dropdown с поиском
- Сгруппированы по провайдеру
  ```
  ▼ opencode
    claude-sonnet-4-5
    claude-opus-4-5
  ▼ zai-coding-plan
    glm-4.6
    glm-4.7
  ```
- При изменении модели:
  - Модель обновляется в UI
  - Фронтматтер обновляется асинхронно

**4.2. Выбор модели при запуске**
- Добавляется модальное окно "Run with custom model"
- Dropdown с выбором модели
- Кнопка "Run" для запуска с выбранной моделью
- Кнопка "Cancel" для отмены
- При запуске:
  - Модель сохраняется во фронтматтере
  - Задача запускается с выбранной моделью

#### 5. Запуск задачи (Task Execution)

**5.1. Последовательность действий**
1. Создаётся Git Worktree для задачи
   - Имя ветки: `feat/task-task-title`
2. Вычисляется путь к файлу задачи от корня проекта
   - Например: `.memory_bank/tasks/auth.md`
3. Формируется команда для запуска агента:
   ```
   opencode -m <provider>/<model-name> run "прочитай и выполни задачу из файла <path_from_root>"
   ```
   - Пример:
     ```
     opencode -m opencode/claude-sonnet-4-5 run "прочитай и выполни задачу из файла .memory_bank/tasks/auth.md"
     ```
4. Команда выполняется в папке созданного Worktree
5. Статус задачи обновляется на "Running"
6. Логи транслируются в UI в реальном времени
7. По завершении статус обновляется на "Done" или "Failed"

**5.2. Логирование**
- В начало логов задачи добавляется информация о модели:
  ```
  [NCrew] Using model: opencode/claude-sonnet-4-5
  ```
- Логируется время запуска и завершения
- Логируется exit code

**5.3. Обработка ошибок**
- Если выбранная модель недоступна:
  - Выводится ошибка из консоли opencode
  - Статус задачи обновляется на "Failed"
  - Пользователю предлагается выбрать другую модель

#### 6. API

**6.1. Получение списка моделей**
```
GET /api/models

Response 200:
{
  "models": [
    {
      "provider": "opencode",
      "name": "claude-sonnet-4-5",
      "fullName": "opencode/claude-sonnet-4-5"
    }
  ],
  "cachedAt": "2025-12-30T10:00:00Z",
  "expiresAt": "2025-12-31T10:00:00Z"
}

Response 503:
{
  "error": "opencode not found in PATH"
}
```

**6.2. Обновление списка моделей**
```
POST /api/models/refresh

Response 200:
{
  "models": [...],
  "cachedAt": "2025-12-30T12:00:00Z",
  "expiresAt": "2025-12-31T12:00:00Z"
}
```

**6.3. Запуск задачи**
```
POST /api/tasks/run

Request:
{
  "taskId": "task-123",
  "model": {
    "agenticHarness": "opencode",
    "modelProvider": "opencode",
    "modelName": "claude-sonnet-4-5"
  }
}

Response 200:
{
  "message": "Task started",
  "taskId": "task-123",
  "worktreePath": "/path/to/worktree",
  "startedAt": "2025-12-30T12:00:00Z"
}
```

**6.4. Обновление модели задачи**
```
PUT /api/tasks/:id/model

Request:
{
  "model": {
    "agenticHarness": "opencode",
    "modelProvider": "opencode",
    "modelName": "claude-sonnet-4-5"
  }
}

Response 200:
{
  "taskId": "task-123",
  "model": {
    "agenticHarness": "opencode",
    "modelProvider": "opencode",
    "modelName": "claude-sonnet-4-5"
  }
}
```

### Нефункциональные требования

**Производительность**
- Кеш списка моделей не должен замедлять UI
- Обновление списка моделей не должно блокировать UI

**Надежность**
- Если opencode не установлен - корректно обрабатывать ошибку
- Если список моделей не получен - показывать сообщение об ошибке

**Совместимость**
- Фронтматтер без полей модели должен корректно обрабатываться
- Должна работать обратная совместимость с существующими задачами

## Ограничения MVP

1. Поддерживается только один agentic harness: `opencode`
2. Промпт для agenta фиксированный: "прочитай и выполни задачу из файла <path>"
3. Нет валидации модели до запуска (проверка только при выполнении)
4. Нет возможности добавлять кастомные модели
5. Нет сохранения истории запусков с разными моделями

## Будущие улучшения

1. Поддержка нескольких agentic harness'ов
2. Кастомизация промпта для каждой задачи
3. Сохранение истории запусков с разными моделями
4. Рейтинг моделей по успешности
5. Автоматический выбор модели на основе типа задачи

## Приемочные критерии (Definition of Done)

1. ✅ Команда `opencode models` выполняется и возвращает список моделей
2. ✅ Список моделей кешируется на 24 часа
3. ✅ Кнопка "Refresh models" принудительно обновляет список
4. ✅ Дефолтная модель задаётся в настройках проекта
5. ✅ Модель задачи выбирается в UI (карточка + модалка при запуске)
6. ✅ Модель задачи сохраняется во фронтматтере
7. ✅ Команда `opencode -m <provider>/<model> run "прочитай и выполни задачу из файла <path>"` выполняется
8. ✅ Логи содержат информацию о использованной модели
9. ✅ Ошибки корректно обрабатываются и выводятся в UI
10. ✅ WebSocket события транслируют прогресс выполнения

## План реализации

### Этап 1: Backend
1. Создать сервис `modelService` для работы с моделями
2. Реализовать выполнение команды `opencode models`
3. Реализовать кеширование списка моделей
4. Добавить API endpoints для получения и обновления моделей
5. Обновить сервис `taskScanner` для парсинга полей модели из фронтматтера
6. Обновить сервис `agentRunner` для передачи модели в команду opencode

### Этап 2: Frontend
1. Создать компонент `ModelSelector` для выбора модели
2. Добавить поле модели в карточку задачи
3. Добавить модальное окно для выбора модели при запуске
4. Обновить компонент `ProjectSettings` для выбора дефолтной модели
5. Обновить API service для работы с моделями

### Этап 3: Интеграция
1. Связать модель задачи с запуском агента
2. Добавить логирование модели в логи задачи
3. Добавить обработку ошибок
4. Обновить WebSocket события

### Этап 4: Тестирование
1. Unit тесты для modelService
2. Integration тесты для API endpoints
3. E2E тесты для полного цикла выполнения задачи

## Риски

1. **Команда opencode не установлена**
   - Решение: Проверка при запуске backend, сообщение пользователю

2. **Список моделей изменился между запусками**
   - Решение: Кеш на 24 часа, принудительное обновление

3. **Выбранная модель недоступна**
   - Решение: Обработка ошибки при запуске, предложение выбрать другую

4. **Фронтматтер повреждён или имеет неверный формат**
   - Решение: Graceful fallback на дефолтную модель проекта
