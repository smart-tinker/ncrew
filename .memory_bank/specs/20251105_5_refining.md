### **Техническое Задание: Рефакторинг NeuroCrew Lab до Чистой Ролевой Архитектуры**

**1. Цель**

Основная цель данного рефакторинга — устранить архитектурные несоответствия и стабилизировать систему, полностью переведя ее на **чистую ролевую архитектуру со stateful-коннекторами**. Текущая кодовая база является нестабильным гибридом двух подходов (старого stateless и нового stateful), что приводит к избыточности кода, усложнению логики и потенциальным ошибкам.

**2. Ключевые Принципы Целевой Архитектуры**

После завершения рефакторинга система **ДОЛЖНА** соответствовать следующим принципам:

1.  **Единый Источник Правды:** Файл `roles/agents.yaml` является **единственным** источником для определения ролей, их команд вызова, системных промптов и последовательности.
2.  **Фиксированная Последовательность:** Последовательность вызова ролей **строго** определяется их порядком в файле `roles/agents.yaml`. Любые другие механизмы определения последовательности должны быть удалены.
3.  **Чисто Stateful-Коннекторы:** Все коннекторы **должны** реализовывать исключительно stateful-интерфейс для управления долгоживущими процессами. Stateless-логика (`execute` с передачей всего контекста) должна быть полностью удалена.
4.  **Безопасность Состояния Ядра:** Ядро `NeuroCrewLab` должно оставаться stateless по отношению к отдельным запросам. Информация о текущей выполняемой роли должна передаваться как аргумент между методами, а не храниться в `self`.

**3. Подробные Задачи по Компонентам**

---

#### **Задача 1: Рефакторинг и Упрощение Конфигурации**

**Цель:** Устранить дублирование и конфликты, сделав `agents.yaml` единственным источником правды для ролей.

**Действия:**

1.  **В файле `roles/agents.yaml`:**
    *   [ ] **Полностью удалить** секцию `sequences`. Файл должен содержать только список `roles`. Порядок ролей в этом списке и будет являться единственной последовательностью.

2.  **В файле `role_config.py`:**
    *   [ ] Из класса `RolesRegistry` **удалить** атрибут `self.sequences` и метод `get_sequence()`.
    *   [ ] Основной задачей `RolesRegistry` становится хранение и предоставление доступа к словарю ролей `self.roles`.

3.  **В файле `config.py`:**
    *   [ ] **Полностью удалить** устаревшие переменные `AGENT_SEQUENCE` и `CLI_PATHS`.
    *   [ ] **Удалить** метод `_load_agent_tokens` и переменную `AGENT_TOKENS`.
    *   [ ] **Упростить `_load_telegram_bot_tokens`:** убрать логику парсинга строки `TELEGRAM_BOT_TOKENS`. Вместо этого, метод должен динамически находить токены в переменных окружения, основываясь на `telegram_bot_name` из уже загруженных ролей.
    *   [ ] **Удалить** функцию `expand_env_vars`. Логика подстановки переменных окружения не используется и только усложняет код.

4.  **В файле `.env.example`:**
    *   [ ] **Удалить** устаревшие переменные `QWEN_CLI_PATH`, `GEMINI_CLI_PATH` и т.д.
    *   [ ] **Удалить** переменную `TELEGRAM_BOT_TOKENS`. Оставить только именованные переменные для токенов ботов (`SOFTWARE_DEV_BOT_TOKEN=...`), чтобы соответствовать новой логике загрузки.

---

#### **Задача 2: Полный Рефакторинг Модуля Коннекторов (КРИТИЧЕСКИ ВАЖНО)**

**Цель:** Привести все коннекторы к единому, чисто stateful-интерфейсу.

**Действия:**

1.  **В файле `connectors/base.py`:**
    *   [ ] **Заменить** текущее содержимое класса `BaseConnector` на следующий **чистый stateful-интерфейс**. Это эталон, которому должны следовать все коннекторы.

    ```python
    # connectors/base.py - ЦЕЛЕВАЯ ВЕРСИЯ
    
    from abc import ABC, abstractmethod
    import asyncio
    from utils.logger import get_logger
    
    class BaseConnector(ABC):
        """Абстрактный базовый класс для STATEFUL-коннекторов к Agentic CLI."""
    
        def __init__(self):
            self.process: asyncio.subprocess.Process | None = None
            self.logger = get_logger(f"{self.__class__.__name__}")
    
        @abstractmethod
        async def launch(self, command: str, system_prompt: str):
            """
            Запускает CLI-процесс в интерактивном режиме и отправляет системный промпт.
            Сохраняет процесс в self.process.
            """
            pass
    
        @abstractmethod
        async def execute(self, delta_prompt: str) -> str:
            """
            Отправляет новую часть диалога (дельту) в запущенный процесс и возвращает ответ.
            """
            pass
    
        async def shutdown(self):
            """Корректно завершает CLI-процесс."""
            if self.process and self.process.returncode is None:
                self.logger.info(f"Завершение процесса {self.process.pid}...")
                try:
                    self.process.terminate()
                    await asyncio.wait_for(self.process.wait(), timeout=5.0)
                    self.logger.info(f"Процесс {self.process.pid} завершен.")
                except asyncio.TimeoutError:
                    self.logger.warning(f"Процесс {self.process.pid} не завершился, принудительное завершение...")
                    self.process.kill()
                    await self.process.wait()
                finally:
                    self.process = None
    
        def is_alive(self) -> bool:
            """Проверяет, активен ли CLI-процесс."""
            return self.process is not None and self.process.returncode is None
    ```

2.  **Для каждого файла коннектора (`qwen_connector.py`, `claude_connector.py` и т.д.):**
    *   [ ] Унаследовать класс от **нового, чистого `BaseConnector`**.
    *   [ ] **Полностью удалить** все старые методы: `format_context`, `parse_response`, `check_availability`, `execute(context_delta)`.
    *   [ ] **Удалить** любые кастомные методы вроде `execute_stateful_with_system_prompt`.
    *   [ ] **Реализовать метод `launch(self, command: str, system_prompt: str)`:**
        *   Логика должна использовать `asyncio.create_subprocess_exec` для запуска `command`.
        *   Сразу после запуска, в `stdin` процесса должен быть отправлен `system_prompt`.
    *   [ ] **Реализовать метод `execute(self, delta_prompt: str)`:**
        *   Логика должна отправлять `delta_prompt` в `stdin` уже запущенного процесса.
        *   **Ключевая задача:** реализовать надежное чтение из `stdout` до конца ответа. **Рекомендуемая стратегия:** читать `stdout` построчно, пока данные поступают. Если в течение короткого таймаута (например, 1.5-2 секунды) новых данных нет, считать ответ завершенным.
    *   [ ] **Добавить файл-заглушку `connectors/opencode_connector.py`**, если он отсутствует.

---

#### **Задача 3: Рефакторинг Ядра Оркестратора (`ncrew.py`)**

**Цель:** Упростить ядро, убрать из него лишнее состояние и адаптировать под работу с чистыми stateful-коннекторами.

**Действия:**

1.  **В классе `NeuroCrewLab`:**
    *   [ ] **Переименовать:**
        *   `chat_agent_pointers` -> `chat_role_pointers`
        *   `_get_next_agent` -> `_get_next_role`
        *   `_process_with_agent` -> `_process_with_role`
    *   [ ] **Удалить** небезопасный атрибут `self.current_role`.
    *   [ ] **Закомментировать или удалить** метод `continue_conversation` и его вызов из `handle_message`. Авто-продолжение диалога — это функциональность для будущих версий.
    *   [ ] **Изменить `handle_message`:**
        *   Метод должен получать `RoleConfig` из `_get_next_role`.
        *   Этот объект `RoleConfig` должен **явно передаваться как аргумент** в `_process_with_role`.
        *   Метод должен возвращать кортеж `(RoleConfig, str)`, содержащий объект роли и "сырой" ответ.
    *   [ ] **Изменить `_process_with_role`:**
        *   **Удалить** все `hasattr` проверки и `if/else` ветки для stateful/stateless.
        *   Метод должен **безальтернативно** вызывать `connector.execute(delta_prompt)`.

---

#### **Задача 4: Финальные Исправления**

1.  **В файле `main.py`:**
    *   [ ] Обновить логику стартового логирования: выводить информацию о загруженных **ролях** из `Config`, а не устаревшие `AGENT_SEQUENCE` и `CLI_PATHS`.

2.  **В файле `telegram_bot.py`:**
    *   [ ] Убедиться, что `handle_message` корректно принимает `(RoleConfig, str)` от `ncrew.py`.
    *   [ ] Для отправки ответа должен использоваться `role_config.telegram_bot_name` для поиска токена.

**4. Критерии Готовности (Definition of Done)**

1.  Все stateless-методы и fallback-логика полностью удалены из коннекторов и `ncrew.py`.
2.  Система успешно запускается и работает, используя **только** `roles/agents.yaml` для конфигурации ролей и последовательности.
3.  При обработке сообщений для каждой роли создается и переиспользуется **один** долгоживущий процесс CLI-агента.
4.  Старые конфигурационные переменные (`AGENT_SEQUENCE`, `CLI_PATHS`, `TELEGRAM_BOT_TOKENS`) полностью удалены из кода.
5.  Все существующие тесты (`tests/`) адаптированы под новую архитектуру и успешно проходят.
6.  Код стал чище, проще для понимания и не содержит "гибридной" логики.