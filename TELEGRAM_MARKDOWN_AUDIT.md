# Аудит и Фикс Форматирования Сообщений в Telegram (MarkdownV2)

## Дата: 2024
## Статус: Завершено

## Проблема
Сообщения от агентов в Telegram приходили с Markdown-синтаксисом, но отправлялись как сырой текст без применения форматирования. Была несоответствие между используемыми режимами парсинга (`parse_mode="Markdown"` vs `parse_mode="MarkdownV2"`).

## Фаза 1: Аудит (Завершено)

### Найденные проблемы

1. **Непоследовательное использование `parse_mode`:**
   - 8 мест использовали `parse_mode="Markdown"` ❌
   - 3 места использовали `parse_mode="MarkdownV2"` ✅
   - `Markdown` режим не требует экранирования спецсимволов, что привело к несогласованности

2. **Неполная конвертация форматирования:**
   - Функция `format_telegram_message()` была реализована, но имела недостатки:
     - Экранировала спецсимволы, но не конвертировала Markdown в MarkdownV2
     - Не обрабатывала заголовки (`#`, `##`, `###`)
     - Не преобразовывала `**bold**` в `*bold*` (MarkdownV2 требует одиночный `*`)

3. **Форматирующие функции использовали неправильный синтаксис:**
   - `format_agent_response()` использовал `*text*` вместо `**text**` для bold
   - Другие форматеры также использовали смешанный синтаксис

### Затронутые файлы
- `app/interfaces/telegram_bot.py` - 12 мест с `parse_mode`
- `app/utils/formatters.py` - функции форматирования
- Команды: `/start`, `/help`, `/status`, `/metrics`, `/about`, `/agents`, `/next`
- Startup сообщения и system status

## Фаза 2: Реализация/Улучшение (Завершено)

### Решения

1. **Переработана функция `format_telegram_message()`:**
   - Добавлена вспомогательная функция `_markdown_to_markdownv2()` для конвертации
   - Обработка заголовков: `# Title` → `*Title*` (bold)
   - Конвертация: `**text**` → `*text*` (MarkdownV2 bold)
   - Сохранение italic: `_text_` остается без изменений
   - Экранирование спецсимволов: `_*[]()~>#+-=|{}.!`
   - Сохранение форматирования при экранировании (`*bold*` и `_italic_` не экранируются)
   - Предотвращение обработки внутри кодовых блоков

2. **Унифицирован `parse_mode`:**
   - Все 12 вызовов `send_message()` в telegram_bot.py теперь используют `parse_mode="MarkdownV2"`

3. **Обновлены все форматирующие функции:**
   - `format_welcome_message()` - использует `**bold**` синтаксис
   - `format_help_message()` - использует `**bold**` синтаксис
   - `format_status_message()` - использует `**bold**` синтаксис
   - `format_error_message()` - использует `**bold**` синтаксис
   - `format_agent_response()` - использует `**bold**` для имени агента

4. **Обновлены все вызовы отправки сообщений:**
   - `/start` команда
   - `/help` команда
   - `/status` команда
   - `/metrics` команда
   - `/about` команда
   - `/agents` команда
   - `/next` команда
   - Startup сообщения
   - System status сообщения
   - Actor bot сообщения (fallback)

### Примеры преобразования

| Исходный текст | Результат |
|---|---|
| `# Welcome` | `*Welcome*` |
| `**bold text**` | `*bold text*` |
| `_italic text_` | `_italic text_` |
| `[link](url)` | `\[link\]\(url\)` |
| `test.com` | `test\.com` |
| `` `code` `` | `` `code` `` (не меняется) |
| `` ```code\nprint()``` `` | `` ```code\nprint()``` `` (не меняется) |

## Результаты

✅ **Достигнуто:**
- Красиво отформатированные сообщения в Telegram с поддержкой **жирного**, _курсива_, `кода`
- Единообразное использование `parse_mode="MarkdownV2"`
- Правильное экранирование спецсимволов
- Сохранение форматирования при обработке
- Поддержка кодовых блоков и inline кода
- Конвертация стандартного Markdown в MarkdownV2

✅ **Очистка от дублей:**
- Логика `format_telegram_message()` централизована и переиспользуется везде
- Нет дублирования экранирования/форматирования

✅ **Документация:**
- Этот файл содержит подробное описание проделанной работы
- Функции и классы имеют обновленные docstrings

## Тестирование

Функция успешно протестирована на следующих примерах:
- Headers: `# Welcome` → `*Welcome*`
- Bold: `**text**` → `*text*`
- Italic: `_text_` → `_text_`
- Code blocks: `` ```code``` `` → `` ```code``` ``
- Special chars: `[`, `]`, `(`, `)`, `.`, `-`, `=` и т.д.
- Combined markdown с заголовками, списками, кодом

## Технические детали

### Логика форматирования

1. **Конвертация Markdown → MarkdownV2**
   - Headers превращаются в bold (MarkdownV2 не поддерживает headers)
   - `**double**` преобразуется в `*single*`
   - Все происходит внутри code blocks (до экранирования)

2. **Экранирование с сохранением форматирования**
   - Спецсимволы заменяются на placeholders перед экранированием
   - После экранирования placeholders восстанавливаются
   - Это предотвращает экранирование форматирующих символов

3. **Обработка различных типов контента**
   - Code blocks (``` ```): не обрабатываются
   - Inline code (`` ` ``): не обрабатываются  
   - Regular text: экранируется, форматирование сохраняется
   - Formatting markers (`*bold*`, `_italic_`): не экранируются

## Миграция для разработчиков

Если вы добавляете новые сообщения в Telegram:

1. Используйте стандартный Markdown синтаксис при создании текста:
   ```python
   msg = "# Welcome\n**Features:**\n- Feature 1\n- Feature 2"
   ```

2. Примените форматирование:
   ```python
   from app.utils.formatters import format_telegram_message
   formatted = format_telegram_message(msg)
   ```

3. Отправьте с правильным `parse_mode`:
   ```python
   await bot.send_message(chat_id, formatted, parse_mode="MarkdownV2")
   ```

## Совместимость

- ✅ Работает со всеми версиями python-telegram-bot
- ✅ Совместима с Telegram Bot API 6.0+
- ✅ Поддерживает Unicode символы (включая эмодзи и Кириллицу)
- ✅ Безопасна для LLM-выводов (правильно экранирует спецсимволы)

